// Log streaming
(function(a,b){function e(a){c.writeMsg("Lost connection... retrying in "+a+" seconds"),setTimeout(function(){d.socket.socket.connected||(d.socket=io.connect())},a*1e3),setTimeout(function(){!d.socket.socket.connected&&!d.socket.socket.connecting&&e(a*2)},(a+3)*1e3)}a.console=a.console||{log:function(){}},a.Etsy=a.Etsy||{},a.Etsy.Supergrep=a.Etsy.Supergrep||{};var c=a.Etsy.Supergrep;c.SortOrder={Ascending:"asc",Descending:"dsc"};var d={socket:null,targetLogs:[],logEntries:[],entryCounter:0,hashes:{},unseen:0,config:{maxEntries:500,sortOrder:c.SortOrder.Descending,autoscroll:!0,filter:null,highlight:null,background:!1,pageTitle:"Supergrep++"},paths:{githubWebPrefix:"https://github.com/your/repo/blob/master/"},regex:{meta:/^((?:web)[\d]+)\s*\:?\s*\[([^\]]+)\]\s\[([^\]]+)\]\s\[(?:client\s*)?([^\]]+)\]/i,meta_dev:/^((?:web)[\d]+)\s*\:?\s*\[([^\]]+)\]\s\[([^\]]+)\]\s\[(?:client\s*)?([^\]]+)\]/i,web:/^((?:web)[\d]+)\s*\:?\s*\[([^\]]+)\]\s(?:\[[^\]]+\])\s\[(?:client\s*)?([^\]]+)\]\s\[([^\]]+)\]\s\[([^\]]+)\]\s\[([^\]]+)\]\s\[([^\]]+)\]\s\[([^\]]+)\]\s+/i,web_dev:/^()\[([^\\[\]]+)\]\s()\[([^\\[\]]+)\]\s+\[([^\]]+)\]\s+\[([^\]]+)\]\s+\[([^\]]+)\]\s+\[([^\]]+)\]\s+/i,gearman:/^((?:web|preprod\-web|atlasweb|api|worker)[\d]+)\s*\:?\s*\[([^\]]+)\]\s()\[([^\]]+)\]\s\[([^\]]+)\]\s\[([^\]]+)\]\s\[([^\]]+)\]\s\[([^\]]+)\]\s+/i,gearman_dev:/^()\[([^\]]+)\]\s()\[([^\]]+)\]\s\[([^\]]+)\]\s\[([^\]]+)\]\s\[([^\]]+)\]\s\[([^\]]+)\]\s+/i,error:/\[(error)\]/ig,warning:/\[(warning)\]/ig,info:/\[((info|notice))\]/ig,debug:/\[(debug)\]/ig,phpFatal:/PHP Fatal/i,stacktrace:/(\s#\d+\s)/g,fullStacktrace:/(?:stack trace:\s+|backtrace:(?:\\n|\s)*)(#\d+.+\.php(?:\:\d+|\(\d+\)))/i,stackSplitter:/\s*#\d+\s+/,stackFile:/(\/your\/path\/here\/|\/home\/[^\\\/]+)/i,phpFile:/\.php/i,stackInternalFunc:/\[internal\sfunction\]:\s*/i,stackFileLine:/\:\d+$/,stackAltFileLine:/\.php\((\d+)\):/i,codepath:/((\/your\/path\/here\/)([^\.]+.php)(?:\(([\d]+)\)|(?:\s*on)?\s+line\s+(\d+)|:(\d+)))/i,devtest:/^\[/,token:/\[([a-z0-9-_]{28})\]/i,severity:/(?:\[[a-z0-9-_]{28}\])\s\[(error|warning)\]/i,fileNotFound:/File does not exist/i,url:/((?:https?:\/\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/ig}};c.submitGist=function(c,d,e){b("#gistform-filename").val("supergrep["+c+"]"+d),b("#gistform-data").val(unescape(e)),b("#gistform").get(0).submit()},c.submitIrc=function(c,d){c=b.trim(c);if(!c)return;if(!c.match(/^(@|#)/))return;var e=c.split(" ");c=e.shift(),d=e.join(" ")+"\n"+d,b.ajax("/v2/irccat",{type:"POST",data:{target:c,data:d}})},c.watchLogs=function(f,g){d.subscribedLogs=f,d.unsubscribedLogs=g,d.socket?d.socket.emit("subscriptions",{subscribeTo:d.subscribedLogs,unsubscribeFrom:d.unsubscribedLogs}):(d.socket=io.connect(document.location.hostname,{transports:["xhr-polling"]}),d.socket.on("connect",function(){b("#loading").hide(),c.writeMsg("Connection established"),d.socket.emit("subscriptions",{subscribeTo:d.subscribedLogs,unsubscribeFrom:d.unsubscribedLogs})}),d.socket.on("lines",function(a){c.writeLogEntries(a)}),d.socket.on("disconnect",function(){d.socket.connected||e(2)}))},c.setBackground=function(c){d.config.background=!!c,d.config.background||(d.unseen=0,b(document).attr("title",d.config.pageTitle))},c.parseFilterRule=function(c){c=b.trim(c);if(c==="")return null;var d=c.match(/^\/(.+)\/([igsm]*)$/);if(d)return new RegExp(d[1],d[2]);c=c.replace(/([\\\/\.\*\+\?\(\)\[\]\{\}\-\|])/g,"\\$1");var e=c.split(/(?:\r\n|\n|\,)+/),f=[];for(var g=0,h=e.length;g<h;g++){var i=b.trim(e[g]);i!==""&&f.push(i)}return f.length?new RegExp("("+f.join("|")+")","i"):null},c.setFilterInvert=function(b){d.config.filterInvert=!!b;for(var c=0,e=d.logEntries.length;c<e;c++)this.evalLogEntry(d.logEntries[c])},c.setFilter=function(b){d.config.filter=c.parseFilterRule(b);for(var e=0,f=d.logEntries.length;e<f;e++)this.evalLogEntry(d.logEntries[e])},c.setHighlight=function(b){d.config.highlight=c.parseFilterRule(b);for(var e=0,f=d.logEntries.length;e<f;e++)this.evalLogEntry(d.logEntries[e])},c.evalLogEntry=function(b){return d.config.highlight&&b.extra.rawdata.match(d.config.highlight)?b.element.addClass("highlight"):b.element.removeClass("highlight"),d.config.filter&&b.extra.rawdata.match(d.config.filter)?d.config.filterInvert?(b.element.removeClass("hide"),!0):(b.element.addClass("hide"),!1):d.config.filter&&d.config.filterInvert?(b.element.addClass("hide"),!1):(b.element.removeClass("hide"),!0)},c.setAutoscroll=function(b){d.config.autoscroll=!!b,c.scrollLog()},c.scrollLog=function(c){if(d.config.sortOrder===this.SortOrder.Ascending){if(!d.config.autoscroll)return;b("html").scrollTop(b("html").height())}else!d.config.autoscroll&&c?b("html").scrollTop(b("html").scrollTop()+c.outerHeight()):b("html").scrollTop(0)},c.setSortOrder=function(c){if(d.config.sortOrder===c)return;d.config.sortOrder=c,b("#results-list").empty();for(var e=0,f=d.logEntries.length;e<f;e++)this.displayEntry(d.logEntries[e].element)},c.getMaxEntries=function(){return d.config.maxEntries},c.setMaxEntries=function(b){if(d.config.maxEntries===b)return;d.config.maxEntries=b,c.trimEntries()},c.trimEntries=function(){while(d.logEntries.length>d.config.maxEntries){var b=d.logEntries.shift();b.element.remove(),b.extra.hash&&delete d.hashes[b.extra.hash]}},c.displayEntry=function(e){d.config.sortOrder===this.SortOrder.Ascending?b(e).appendTo("#results-list"):b(e).prependTo("#results-list"),c.scrollLog(b(e))},c.addEntry=function(e,f){e=b(e);var g={element:e,extra:f},h=c.evalLogEntry(g);d.logEntries.push(g),this.displayEntry(e),this.trimEntries(),h&&d.config.background&&(d.unseen++,b(document).attr("title","("+d.unseen+" new) "+d.config.pageTitle))},c.clearEntries=function(){d.logEntries=[],b("#results-list").empty()},c.writeMsg=function(c){var e={id:"msg"+d.entryCounter++,data:c,rawdata:c};this.addEntry(b(CWinberry.Templating.render("tpl_msgEntry",e)),e)},c.parseLogEntry=function(c,e){try{var f={ns:c,rawdata:e,id:"log"+d.entryCounter++},g=d.regex.devtest.test(e),h=e.match(d.regex.meta),i=e.match(d.regex.error),j=e.match(d.regex.warning),k=e.match(d.regex.token),l=e.match(d.regex.severity),m=l?l[1]:"info";if(c==="web"){var n=e.match(c==="gearman"?g?d.regex.gearman_dev:d.regex.gearman:g?d.regex.web_dev:d.regex.web);if(n&&n.length===9){e=e.replace(n[0],""),f.server=n[1]||"localhost",f.timestamp=new Date(n[2]),isNaN(f.timestamp.getTime())&&(f.timestamp=new Date(0)),f.client=n[3]||"127.0.0.1",f.hash=n[4],f.severity=n[5],f.namespace=n[6];var o=n[7]?n[7].split(":"):["",0];f.path={url:n[7].replace(d.regex.codepath,d.paths.githubWebPrefix+"$3#L$4$5$6"),file:o[0].replace(d.regex.stackFile,""),line:o[1]},f.userid=n[8]&&n[8]!=="0"?n[8]:"";var p=e.match(d.regex.fullStacktrace);if(p){f.stacktrace=[];var q=p[1].split(d.regex.stackSplitter);q.shift();for(var r=0,s=q.length;r<s;r++){var t=q[r].replace(d.regex.stackInternalFunc,"").split(" "),u;q[r].match(d.regex.phpFile)?u=q[r].match(d.regex.stackAltFileLine)?t.shift().replace(d.regex.stackAltFileLine,".php:$1"):t.pop():u="";var v;u.match(d.regex.stackFileLine)?v=u.split(":"):(v=["","0"],t.push(u));var w=t.join(" "),x=v[0].replace(d.regex.stackFile,""),y=v[1].replace("):","");x.indexOf("/")===0&&(x=x.substring(1)),f.stacktrace.push({call:w,file:x,line:y,url:x?d.paths.githubWebPrefix+x+"#L"+y:""})}e=e.replace(p[0],"")}}else{if(h&&h.length===5){f.server=h[1],f.timestamp=new Date(h[2]),f.severity=h[3],f.client=h[4];var z={server:h[1],timestamp:h[2],apache_info:h[3],client:h[4]}}for(var A in z)regex=new RegExp("("+z[A].replace("[","\\[").replace("]","\\]")+")","g"),e=e.replace(regex,'<span class="'+A+'">$1</span>')}}else e=e+(name?'<span class="name">['+name+"]</span> ":"")+e;return e=e.replace(d.regex.url,"<a target='_blank' href='$1'>$1</a>"),k&&(f.token=k[1]),e=e.replace(d.regex.codepath,'<a target="_blank" href="'+d.paths.githubWebPrefix+'$3#L$4$5$6">$3:$4$5$6</a>'),f.rawdata.match(d.regex.phpFatal)&&(f.isFatal=!0),f.data=b.trim(e),f}catch(B){console.log(B)}},c.writeLogEntry=function(c,e){var f=hex_sha256(e);if(d.hashes[f])return;var g=this.parseLogEntry(c,e);d.hashes[f]=1,g.hash=f,this.addEntry(b(CWinberry.Templating.render("tpl_logEntry",g)),g)},c.writeLogEntries=function(d){b.each(d.lines,function(a,b){c.writeLogEntry(d.name,b)})}})(window,jQuery);